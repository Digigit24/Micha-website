<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Micha Website</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
</head>

<body>
    <div class="admin-layout">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="brand">
                <span>⚡ AdminPanel</span>
            </div>
            <ul class="menu">
                <li class="menu-item active" onclick="showSection('all-products')">All Products</li>
                <li class="menu-item" onclick="showSection('add-product')">Add Product</li>
                <li class="menu-item" onclick="showSection('banner-edit')">Banner Edit</li>
                <li class="menu-item" onclick="showSection('sale-edit')">Sale Edit</li>
                <li class="menu-item" onclick="showSection('orders')">Orders</li>
            </ul>
            <div style="margin-top: auto;">
                <button id="logoutBtn" class="btn-danger">Logout</button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="dashboard-header">
                <h2>Welcome, <span id="adminName">Admin</span></h2>
            </div>

            <!-- SECTION: All Products -->
            <div id="all-products" class="section active">
                <h3>All Products</h3>
                <div id="loadingProducts">Loading products...</div>
                <div id="productGrid" class="product-grid"></div>
            </div>

            <!-- SECTION: Add Product -->
            <div id="add-product" class="section">
                <div class="add-product-card">
                    <h3>Add New Product</h3>
                    <form id="addProductForm" enctype="multipart/form-data">
                        <div class="form-grid">
                            <div class="form-group span-full">
                                <label for="title">Product Title</label>
                                <input type="text" id="title" name="title"
                                    placeholder="e.g. Wireless Noise Cancelling Headphones" required>
                            </div>
                            <div class="form-group span-full">
                                <label for="description">Description</label>
                                <textarea id="description" name="description" rows="4"
                                    placeholder="Detailed product description..." required></textarea>
                            </div>
                            <div class="form-group span-full">
                                <label for="categories">Categories (comma separated)</label>
                                <input type="text" id="categories" name="categories"
                                    placeholder="Electronics, Audio, Wireless" required>
                            </div>
                            <div class="form-group">
                                <label for="mrp">MRP (₹)</label>
                                <input type="number" id="mrp" name="mrp" placeholder="2999" required>
                            </div>
                            <div class="form-group">
                                <label for="discountedPrice">Discounted Price (₹)</label>
                                <input type="number" id="discountedPrice" name="discountedPrice" placeholder="2499"
                                    required>
                            </div>
                            <div class="form-group span-full">
                                <label for="tags">Tags (comma separated)</label>
                                <input type="text" id="tags" name="tags" placeholder="bass, premium, sale">
                            </div>
                            <div class="form-group span-full checkbox-group">
                                <div class="checkbox-item">
                                    <input type="checkbox" id="feature" name="feature" value="true">
                                    <label for="feature">Featured Product</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="available" name="available" value="true" checked>
                                    <label for="available">Available in Stock</label>
                                </div>
                            </div>
                            <div class="form-group span-full">
                                <label for="images">Product Images (Max 10)</label>
                                <input type="file" id="images" name="images" multiple accept="image/*" required>
                            </div>
                            <div class="form-group span-full" style="margin-top: 1rem;">
                                <button type="submit">Add Product</button>
                            </div>
                        </div>
                    </form>
                    <div id="productMessage" class="message"></div>
                </div>
            </div>

            <!-- SECTION: Banner Edit -->
            <div id="banner-edit" class="section">
                <h3>Banner Management</h3>

                <div class="add-product-card" style="margin-bottom: 2rem;">
                    <h4>Add New Banner</h4>
                    <form id="addBannerForm" enctype="multipart/form-data">
                        <div class="form-grid">
                            <div class="form-group span-full">
                                <label for="bannerTitle">Title (Optional)</label>
                                <input type="text" id="bannerTitle" name="title" placeholder="e.g. Summer Sale">
                            </div>
                            <div class="form-group span-full">
                                <label for="bannerDesc">Description (Optional)</label>
                                <input type="text" id="bannerDesc" name="description" placeholder="e.g. Up to 50% Off">
                            </div>
                            <div class="form-group">
                                <label for="bannerLink">Link (Optional)</label>
                                <input type="text" id="bannerLink" name="link" placeholder="/products/sale">
                            </div>
                            <div class="form-group">
                                <label for="bannerOrder">Display Order</label>
                                <input type="number" id="bannerOrder" name="order" value="0">
                            </div>
                            <div class="form-group span-full">
                                <label for="bannerImage">Banner Image</label>
                                <input type="file" id="bannerImage" name="image" accept="image/*" required>
                            </div>
                            <div class="form-group span-full checkbox-group">
                                <div class="checkbox-item">
                                    <input type="checkbox" id="bannerActive" name="active" value="true" checked>
                                    <label for="bannerActive">Active</label>
                                </div>
                            </div>
                            <div class="form-group span-full">
                                <button type="submit">Add Banner</button>
                            </div>
                        </div>
                    </form>
                    <div id="bannerMessage" class="message"></div>
                </div>

                <h3>Current Banners</h3>
                <div id="bannerGrid" class="product-grid">
                    <!-- Banners will be loaded here -->
                </div>
            </div>

            <!-- SECTION: Sale Edit -->
            <div id="sale-edit" class="section">
                <h3>Sale Banner Management</h3>
                <p class="text-secondary" style="margin-bottom: 2rem">Only one Sale Banner can be active at a time.
                    Adding a new one replaces the existing one.</p>

                <div class="add-product-card">
                    <h4>Set Sale Banner</h4>
                    <form id="saleBannerForm" enctype="multipart/form-data">
                        <div class="form-grid">
                            <div class="form-group span-full">
                                <label for="saleTitle">Sale Title (Optional)</label>
                                <input type="text" id="saleTitle" name="title" placeholder="e.g. Flash Sale!">
                            </div>
                            <div class="form-group span-full">
                                <label for="saleLink">Link (Optional)</label>
                                <input type="text" id="saleLink" name="link" placeholder="/products/flash-sale">
                            </div>
                            <div class="form-group">
                                <label for="saleStartTime">Start Time</label>
                                <input type="datetime-local" id="saleStartTime" name="startTime" required>
                            </div>
                            <div class="form-group span-full">
                                <label>Duration</label>
                                <div style="display: flex; gap: 10px;">
                                    <div style="flex:1">
                                        <input type="number" id="saleDurationH" name="durationHours" placeholder="Hours"
                                            min="0" value="24" required>
                                        <small>Hours</small>
                                    </div>
                                    <div style="flex:1">
                                        <input type="number" id="saleDurationM" name="durationMinutes"
                                            placeholder="Mins" min="0" max="59" value="0">
                                        <small>Minutes</small>
                                    </div>
                                    <div style="flex:1">
                                        <input type="number" id="saleDurationS" name="durationSeconds"
                                            placeholder="Secs" min="0" max="59" value="0">
                                        <small>Seconds</small>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group span-full">
                                <label for="saleImage">Banner Image</label>
                                <input type="file" id="saleImage" name="image" accept="image/*" required>
                            </div>
                            <div class="form-group span-full">
                                <button type="submit">Set Sale Banner</button>
                            </div>
                        </div>
                    </form>
                    <div id="saleMessage" class="message"></div>
                </div>

                <h3 style="margin-top:2rem;">Current Sale Banner</h3>
                <div id="currentSaleContainer" class="product-grid"
                    style="grid-template-columns: 1fr; max-width: 500px;">
                    <!-- Sale Banner loaded here -->
                </div>
            </div>

            <!-- SECTION: Orders -->
            <div id="orders" class="section">
                <h3>Orders</h3>
                <div class="placeholder-content">
                    Order management functionality coming soon.
                </div>
            </div>

        </main>
    </div>

    <!-- Edit Product Modal -->
    <div id="editProductModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeEditModal()">&times;</span>
            <h3>Edit Product</h3>
            <form id="editProductForm" enctype="multipart/form-data">
                <input type="hidden" id="editProductId" name="id">
                <div class="form-grid">
                    <div class="form-group span-full">
                        <label for="editTitle">Product Title</label>
                        <input type="text" id="editTitle" name="title" required>
                    </div>
                    <div class="form-group span-full">
                        <label for="editDescription">Description</label>
                        <textarea id="editDescription" name="description" rows="4" required></textarea>
                    </div>
                    <div class="form-group span-full">
                        <label for="editCategories">Categories</label>
                        <input type="text" id="editCategories" name="categories" required>
                    </div>
                    <div class="form-group">
                        <label for="editMrp">MRP (₹)</label>
                        <input type="number" id="editMrp" name="mrp" required>
                    </div>
                    <div class="form-group">
                        <label for="editDiscountedPrice">Discounted Price (₹)</label>
                        <input type="number" id="editDiscountedPrice" name="discountedPrice" required>
                    </div>
                    <div class="form-group span-full">
                        <label for="editTags">Tags</label>
                        <input type="text" id="editTags" name="tags">
                    </div>
                    <div class="form-group span-full checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="editFeature" name="feature" value="true">
                            <label for="editFeature">Featured</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="editAvailable" name="available" value="true">
                            <label for="editAvailable">Available</label>
                        </div>
                    </div>
                    <div class="form-group span-full">
                        <label for="editImages">Add New Images (Optional)</label>
                        <input type="file" id="editImages" name="images" multiple accept="image/*">
                    </div>
                    <div class="form-group span-full" style="margin-top: 1rem;">
                        <button type="submit">Update Product</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_BASE = `http://${window.location.hostname}:3000/api/admin`;
        const PRODUCT_API = `http://${window.location.hostname}:3000/api/products`;
        const SERVER_BASE = `http://${window.location.hostname}:3000`;

        let currentProducts = []; // Store products for easy access

        // Authentication Check
        fetch(`${API_BASE}/check-auth`, { credentials: 'include' })
            .then(res => {
                if (!res.ok) throw new Error('Not authenticated');
                return res.json();
            })
            .then(data => {
                document.getElementById('adminName').textContent = data.user.username;
                loadProducts();
            })
            .catch(() => {
                window.location.href = 'login.html';
            });

        function showSection(sectionId) {
            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.remove('active');
                if (item.getAttribute('onclick').includes(sectionId)) {
                    item.classList.add('active');
                }
            });
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(sectionId).classList.add('active');
            if (sectionId === 'all-products') {
                loadProducts();
            }
        }

        async function loadProducts() {
            const grid = document.getElementById('productGrid');
            const loading = document.getElementById('loadingProducts');

            try {
                const response = await fetch(`${PRODUCT_API}/all`);
                currentProducts = await response.json();

                loading.style.display = 'none';
                grid.innerHTML = '';

                if (currentProducts.length === 0) {
                    grid.innerHTML = '<p>No products found.</p>';
                    return;
                }

                currentProducts.forEach(product => {
                    const discount = product.discount || 0;
                    const card = document.createElement('div');
                    card.className = 'product-card';

                    const imageUrl = product.images.length > 0
                        ? `${SERVER_BASE}${product.images[0]}`
                        : 'https://via.placeholder.com/280x200?text=No+Image';

                    card.innerHTML = `
                         <img src="${imageUrl}" alt="${product.title}">
                         <div class="product-info">
                            <div class="product-title">${product.title}</div>
                            <div class="price-row">
                                <span class="price-discounted">₹${product.discountedPrice}</span>
                                <span class="price-mrp">₹${product.mrp}</span>
                                <span class="discount-badge">${discount}% OFF</span>
                            </div>
                            <div class="meta-row">
                                ${product.categories && product.categories.length ? product.categories.join(', ') : 'No Category'}
                            </div>
                            <div class="status-row">
                                ${product.feature ? '<span class="status-featured">★ Featured</span>' : ''}
                                ${!product.available ? '<span class="status-out">Out of Stock</span>' : '<span style="color:green;">In Stock</span>'}
                            </div>
                            <div class="card-actions">
                                <button class="btn-sm btn-edit" onclick="openEditModal('${product._id}')">Edit</button>
                                <button class="btn-sm btn-delete" onclick="deleteProduct('${product._id}')">Delete</button>
                            </div>
                         </div>
                    `;
                    grid.appendChild(card);
                });

            } catch (error) {
                console.error('Error loading products:', error);
                loading.textContent = 'Error loading products.';
            }
        }

        // --- EDIT MODAL LOGIC ---
        const editModal = document.getElementById('editProductModal');
        const editForm = document.getElementById('editProductForm');

        function openEditModal(productId) {
            const product = currentProducts.find(p => p._id === productId);
            if (!product) return;

            // Populate form
            document.getElementById('editProductId').value = product._id;
            document.getElementById('editTitle').value = product.title;
            document.getElementById('editDescription').value = product.description;
            // Handle arrays -> comma separated strings
            document.getElementById('editCategories').value = product.categories ? product.categories.join(', ') : '';
            document.getElementById('editTags').value = product.tags ? product.tags.join(', ') : '';

            document.getElementById('editMrp').value = product.mrp;
            document.getElementById('editDiscountedPrice').value = product.discountedPrice;

            document.getElementById('editFeature').checked = product.feature;
            document.getElementById('editAvailable').checked = product.available;

            editModal.classList.add('active');
        }

        function closeEditModal() {
            editModal.classList.remove('active');
            editForm.reset();
        }

        // Close modal when clicking outside
        window.onclick = function (event) {
            if (event.target == editModal) {
                closeEditModal();
            }
        }

        editForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const productId = document.getElementById('editProductId').value;
            const formData = new FormData(editForm);

            try {
                const response = await fetch(`${PRODUCT_API}/${productId}`, {
                    method: 'PUT',
                    credentials: 'include',
                    body: formData
                });

                if (response.ok) {
                    alert('Product updated successfully!');
                    closeEditModal();
                    loadProducts(); // Refresh list
                } else {
                    const result = await response.json();
                    alert(result.message || 'Error updating product');
                }
            } catch (error) {
                console.error(error);
                alert('Network error occurred.');
            }
        });

        // --- DELETE LOGIC ---
        async function deleteProduct(productId) {
            if (!confirm('Are you sure you want to delete this product? This action cannot be undone.')) {
                return;
            }

            try {
                const response = await fetch(`${PRODUCT_API}/${productId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                if (response.ok) {
                    loadProducts();
                } else {
                    const result = await response.json();
                    alert(result.message || 'Error deleting product');
                }
            } catch (error) {
                console.error(error);
                alert('Network error occurred.');
            }
        }

        // Add Product Form Logic
        const addProductForm = document.getElementById('addProductForm');
        const productMessage = document.getElementById('productMessage');

        addProductForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            productMessage.style.display = 'none';
            productMessage.className = 'message';

            const formData = new FormData(addProductForm);

            try {
                const response = await fetch(`${PRODUCT_API}/add`, {
                    method: 'POST',
                    credentials: 'include',
                    body: formData
                });

                const result = await response.json();

                if (response.ok) {
                    productMessage.textContent = 'Product added successfully!';
                    productMessage.classList.add('success');
                    productMessage.style.display = 'block';
                    addProductForm.reset();
                    // Optionally switch to all products
                    // showSection('all-products');
                } else {
                    productMessage.textContent = result.message || 'Error adding product';
                    productMessage.classList.add('error');
                    productMessage.style.display = 'block';
                }
            } catch (error) {
                console.error(error);
                productMessage.textContent = 'Network error occurred.';
                productMessage.classList.add('error');
                productMessage.style.display = 'block';
            }
        });

        // Logout
        document.getElementById('logoutBtn').addEventListener('click', async () => {
            try {
                await fetch(`${API_BASE}/logout`, {
                    method: 'POST',
                    credentials: 'include'
                });
                window.location.href = 'login.html';
            } catch (error) {
                console.error('Logout failed:', error);
            }
        });
        // --- BANNER LOGIC ---
        const BANNER_API = `http://${window.location.hostname}:3000/api/banners`;
        const addBannerForm = document.getElementById('addBannerForm');
        const bannerMessage = document.getElementById('bannerMessage');

        // Enhance navigation to load banners
        const _originalShowSection = showSection;
        showSection = function (sectionId) {
            // Call original logic (which handles class toggling)
            // We can duplicate logic or rely on the fact that existing function works. 
            // To be safe and clean, let's copy the logic here or update the main function.
            // Updating main function is better (see previous step or just override).

            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.remove('active');
                if (item.getAttribute('onclick').includes(sectionId)) {
                    item.classList.add('active');
                }
            });

            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(sectionId).classList.add('active');

            if (sectionId === 'all-products') {
                loadProducts();
            } else if (sectionId === 'banner-edit') {
                loadBanners();
            }
        }

        async function loadBanners() {
            const grid = document.getElementById('bannerGrid');
            grid.innerHTML = '<p>Loading banners...</p>';

            try {
                const response = await fetch(`${BANNER_API}/all`);
                const banners = await response.json();

                grid.innerHTML = '';
                if (banners.length === 0) {
                    grid.innerHTML = '<p>No banners found.</p>';
                    return;
                }

                banners.forEach(banner => {
                    const card = document.createElement('div');
                    card.className = 'product-card'; // Reuse product card styles

                    const activeStatus = banner.active
                        ? '<span style="color:green; font-weight:bold;">Active</span>'
                        : '<span style="color:red;">Inactive</span>';

                    card.innerHTML = `
                        <img src="${SERVER_BASE}${banner.imageUrl}" alt="Banner" style="height: 150px; object-fit: cover;">
                        <div class="product-info">
                            <div class="product-title">${banner.title || 'Untitled Banner'}</div>
                            <div style="font-size: 0.9rem; color: #666; margin-bottom: 0.5rem;">
                                Order: ${banner.order} | ${activeStatus}
                            </div>
                            <div class="card-actions">
                                <button class="btn-sm btn-delete" onclick="deleteBanner('${banner._id}')">Delete</button>
                            </div>
                        </div>
                    `;
                    grid.appendChild(card);
                });
            } catch (error) {
                console.error(error);
                grid.innerHTML = '<p>Error loading banners.</p>';
            }
        }

        addBannerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            bannerMessage.style.display = 'none';

            const formData = new FormData(addBannerForm);

            try {
                const response = await fetch(`${BANNER_API}/add`, {
                    method: 'POST',
                    credentials: 'include',
                    body: formData
                });

                if (response.ok) {
                    bannerMessage.textContent = 'Banner added successfully!';
                    bannerMessage.classList.add('success');
                    bannerMessage.style.display = 'block';
                    addBannerForm.reset();
                    loadBanners();
                } else {
                    const res = await response.json();
                    bannerMessage.textContent = res.message || 'Error adding banner';
                    bannerMessage.classList.add('error');
                    bannerMessage.style.display = 'block';
                }
            } catch (error) {
                console.error(error);
                bannerMessage.textContent = 'Network error.';
                bannerMessage.classList.add('error');
                bannerMessage.style.display = 'block';
            }
        });

        async function deleteBanner(id) {
            if (!confirm('Are you sure you want to delete this banner?')) return;

            try {
                const response = await fetch(`${BANNER_API}/${id}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });
                if (response.ok) {
                    loadBanners();
                } else {
                    alert('Error deleting banner');
                }
            } catch (e) {
                console.error(e);
                alert('Network error');
            }
        }
        // --- SALE BANNER LOGIC ---
        const SALE_API = `http://${window.location.hostname}:3000/api/sale-banner`;
        const saleBannerForm = document.getElementById('saleBannerForm');
        const saleMessage = document.getElementById('saleMessage');

        // Update showSection to load sale banner
        const _prevShowSection = showSection;
        showSection = function (sectionId) {
            // Reset Menu & Sections (Duplicated logic for clarity/isolation)
            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.remove('active');
                if (item.getAttribute('onclick').includes(sectionId)) {
                    item.classList.add('active');
                }
            });
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(sectionId).classList.add('active');

            if (sectionId === 'all-products') loadProducts();
            else if (sectionId === 'banner-edit') loadBanners();
            else if (sectionId === 'sale-edit') loadSaleBanner();
        }

        async function loadSaleBanner() {
            const container = document.getElementById('currentSaleContainer');
            container.innerHTML = '<p>Loading...</p>';

            try {
                const response = await fetch(SALE_API);
                const banner = await response.json(); // could be null

                container.innerHTML = '';
                if (!banner) {
                    container.innerHTML = '<p class="placeholder-content">No sale banner set.</p>';
                    return;
                }

                // Calculate status
                const now = new Date();
                const start = new Date(banner.startTime);
                const end = new Date(banner.endTime);

                let statusBadge = '';
                if (now < start) {
                    statusBadge = '<span class="status-badge" style="background:#fbbf24; color:white;">Upcoming</span>';
                } else if (now >= start && now <= end) {
                    statusBadge = '<span class="status-badge" style="background:green; color:white;">Active</span>';
                } else {
                    statusBadge = '<span class="status-badge" style="background:grey; color:white;">Disabled (Expired)</span>';
                }

                const card = document.createElement('div');
                card.className = 'product-card';
                card.innerHTML = `
                    <div style="position:relative;">
                        <img src="${SERVER_BASE}${banner.imageUrl}" alt="Sale Banner" style="height: 200px; width:100%; object-fit: cover; border-radius: 8px;">
                        <div style="position:absolute; top:10px; right:10px; padding:5px 10px; border-radius:4px; font-weight:bold;">
                            ${statusBadge}
                        </div>
                    </div>
                    <div class="product-info">
                        <div class="product-title">${banner.title || 'Sale Banner'}</div>
                        <div style="font-size:0.9rem; color:#555; margin-bottom:0.5rem;">
                            <strong>Starts:</strong> ${start.toLocaleString()}<br>
                            <strong>Ends:</strong> ${end.toLocaleString()}
                        </div>
                        <div class="card-actions">
                             <button class="btn-sm btn-delete" onclick="deleteSaleBanner()">Remove</button>
                        </div>
                    </div>
                `;
                container.appendChild(card);

            } catch (error) {
                console.error(error);
                container.innerHTML = '<p>Error loading sale banner.</p>';
            }
        }

        saleBannerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            saleMessage.style.display = 'none';
            const formData = new FormData(saleBannerForm);

            try {
                const response = await fetch(SALE_API, {
                    method: 'POST',
                    credentials: 'include',
                    body: formData
                });

                if (response.ok) {
                    saleMessage.textContent = 'Sale banner updated!';
                    saleMessage.classList.add('success');
                    saleMessage.style.display = 'block';
                    saleBannerForm.reset();
                    loadSaleBanner();
                } else {
                    const res = await response.json();
                    saleMessage.textContent = res.message || 'Error updating banner';
                    saleMessage.classList.add('error');
                    saleMessage.style.display = 'block';
                }
            } catch (e) {
                console.error(e);
                saleMessage.textContent = 'Network error';
                saleMessage.classList.add('error');
                saleMessage.style.display = 'block';
            }
        });

        async function deleteSaleBanner() {
            if (!confirm('Delete current sale banner?')) return;
            try {
                await fetch(SALE_API, { method: 'DELETE', credentials: 'include' });
                loadSaleBanner();
            } catch (e) { console.error(e); }
        }
    </script>
</body>

</html>